---
Rtitle: "Projet Final"
author: "Samuel CHICHA"
date: "10/03/2020"
output: pdf_document
params:
  pokemon: "Persian"
---

```{r setup, include=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Checking if library is well imported and install them if not
if(!require(readr)){
  install.packages("readr")
  require(readr)
}
if(!require(dplyr)){
  install.packages("dplyr")
  require(dplyr)
}
if(!require(ggplot2)){
  install.packages("ggplot2")
  require(ggplot2)
}
if(!require(fmsb)){
  install.packages("fmsb")
  require(fmsb)
}
#Downloading pokemon dataset if it is not there already.
if(!file.exists("data/pokemon.csv"))
  download.file(url = "https://courses.datacrunch.sh/courses/intro-analyse-r/TD6/pokemon.csv", destfile = "data/pokemon.csv", mode = "wb")
#Downloading poekmon weakness and strength dataset if it is not there already.
if(!file.exists("data/pokemon_ws.csv"))
  download.file(url = "https://raw.githubusercontent.com/zonination/pokemon-chart/master/chart.csv", destfile = "data/pokemon_ws.csv", mode = "wb")

pokemons <- read_csv("data/pokemon.csv")
```

# Base de données

```{r Introduction to the database, echo=FALSE}
#Computing number of generations, pokemons and legendary ones
nb_gen <- unique(pokemons$Generation) %>% length()
nb_pokemons <- nrow(pokemons)
nb_leg <- pokemons %>% filter(Legendary==TRUE) %>% nrow()
picked <- params$pokemon
```

La base de données présente une liste de `r nb_pokemons` pokémons étalés sur `r nb_gen` générations dont `r nb_leg` sont légendaires. 
Nous étudierons ici le pokémon "`r picked`".

# Etude du pokémon

```{r Introduction to the pokemon, echo=FALSE}
#Getting the pokemon we picked
pokemon <- filter(pokemons, Name == picked)
if(nrow(pokemon) != 1) stop("Le pokémon n'existe pas.")
```

1. Fiche du pokémon

>
> __Nom__: `r pokemon$Name`
>
> __Type 1__: `r pokemon$'Type 1'`
>
> __Type 2__: `r ifelse(!is.na(pokemon %>% select("Type 2")), pokemon %>% select("Type 2"), "None")`
>
> __Points de vie__: `r pokemon$HP`
>
> __Attaque__: `r pokemon$Attack`
>
> __Defense__: `r pokemon$Defense`
>
> __Attaque spécial__: `r pokemon$'Sp. Atk'`
>
> __Défense spécial__: `r pokemon$'Sp. Def'`
>
> __Vitesse__: `r pokemon$Speed`

2. Comparaison avec les pokémons issus de la même génération

```{r First comparison, echo=FALSE}
#Getting pokemons of the same generation than the one we picked
same_gen_pokemons <- pokemons %>% filter(Generation == pokemon$Generation)

#Creating minimum row
result.min <- cbind(
  same_gen_pokemons$HP %>% min(),
  same_gen_pokemons$Attack %>% min(),
  same_gen_pokemons$Defense %>% min(),
  same_gen_pokemons$`Sp. Atk` %>% min(),
  same_gen_pokemons$`Sp. Def` %>% min(),
  same_gen_pokemons$Speed %>% min()
  )
colnames(result.min) <- same_gen_pokemons[5:10] %>% colnames()
rownames(result.min) <- "Minimum"

#Creating maximum row
result.max <- cbind(
  same_gen_pokemons$HP %>% max(),
  same_gen_pokemons$Attack %>% max(),
  same_gen_pokemons$Defense %>% max(),
  same_gen_pokemons$`Sp. Atk` %>% max(),
  same_gen_pokemons$`Sp. Def` %>% max(),
  same_gen_pokemons$Speed %>% max()
  )
colnames(result.max) <- same_gen_pokemons[5:10] %>% colnames()
rownames(result.max) <- "Maximum"

#Creating mean row
result.mean <- cbind(
  same_gen_pokemons$HP %>% mean(),
  same_gen_pokemons$Attack %>% mean(),
  same_gen_pokemons$Defense %>% mean(),
  same_gen_pokemons$`Sp. Atk` %>% mean(),
  same_gen_pokemons$`Sp. Def` %>% mean(),
  same_gen_pokemons$Speed %>% mean()
  )
colnames(result.mean) <- same_gen_pokemons[5:10] %>% colnames()
rownames(result.mean) <- "Moyenne"

#Subdata of our pokemon
sub <- cbind(
  pokemon$HP,
  pokemon$Attack,
  pokemon$Defense,
  pokemon$`Sp. Atk`,
  pokemon$`Sp. Def`,
  pokemon$Speed
  )
colnames(sub) <- same_gen_pokemons[5:10] %>% colnames()
rownames(sub) <- picked

#Gathering results
result <- rbind(
  result.max,
  result.min,
  result.mean,
  sub
  ) %>% as.data.frame()

# Radar chart color assignment
colors_border <- c( rgb(0.2,0.5,0.5,0.9), rgb(0.8,0.2,0.5,0.9), rgb(0.7,0.5,0.1,0.9))
colors_in <- c( rgb(0.2,0.5,0.5,0.4), rgb(0.8,0.2,0.5,0.4), rgb(0.7,0.5,0.1,0.4))

# Creating the chart
# https://www.rdocumentation.org/packages/fmsb/versions/0.7.0/topics/radarchart
radarchart(
  result,
  axistype=1,
  pcol=colors_border,
  pfcol=colors_in,
  plwd=4,
  plty=1,
  cglcol="grey",
  cglty=1,
  axislabcol="grey",
  cglwd=0.8,
  vlcex=0.8,
  title = paste("Comparaison entre", picked) %>% paste("et les pokémons de la même génération.", sep = "\n")
  )

# Add a legend
legend(
  x=1.3,
  y=1.3,
  legend=rownames(result[-c(1,2),]),
  bty="n",
  pch=20,
  col=colors_in,
  text.col="black",
  cex=1.2,
  pt.cex=3
  )
```

3. Comparaison avec les pokémons ayant les mêmes types

```{r Second comparison, echo = FALSE}
#Getting pokemons of the same generation and same type than the one we picked
same_type_pokemons <- same_gen_pokemons %>% filter(`Type 1` == pokemon$`Type 1`) #Better ?
if(!is.na(pokemon$`Type 2`))
  same_type_pokemons <- same_type_pokemons %>% filter(`Type 2` == pokemon$`Type 2`)

result["Maximum", ] <- c(
  same_type_pokemons$HP %>% max(),
  same_type_pokemons$Attack %>% max(), 
  same_type_pokemons$Defense %>% max(), 
  same_type_pokemons$`Sp. Atk` %>% max(), 
  same_type_pokemons$`Sp. Def` %>% max(), 
  same_type_pokemons$Speed %>% max()
  )

result["Minimum", ] <- c(
  same_type_pokemons$HP %>% min(),
  same_type_pokemons$Attack %>% min(),
  same_type_pokemons$Defense %>% min(),
  same_type_pokemons$`Sp. Atk` %>% min(),
  same_type_pokemons$`Sp. Def` %>% min(),
  same_type_pokemons$Speed %>% min()
  )

result["Moyenne",] <- c(
  same_type_pokemons$HP %>% mean(),
  same_type_pokemons$Attack %>% mean(),
  same_type_pokemons$Defense %>% mean(),
  same_type_pokemons$`Sp. Atk` %>% mean(),
  same_type_pokemons$`Sp. Def` %>% mean(),
  same_type_pokemons$Speed %>% mean()
  )

#Creating the chart
radarchart(
  result,
  axistype=1,
  pcol=colors_border,
  pfcol=colors_in,
  plwd=4,
  plty=1,
  cglcol="grey",
  cglty=1,
  axislabcol="grey",
  cglwd=0.8,
  vlcex=0.8,
  title = paste("Comparaison entre", picked) %>% paste("et les pokémons de la même génération et du même type.", sep = "\n")
  )

# Add a legend
legend(
  x=1.3,
  y=1.3,
  legend=rownames(result[-c(1,2),]),
  bty="n",
  pch=20,
  col=colors_in,
  text.col="black",
  cex=1.2,
  pt.cex=3
  )
```

# Battre Lugia

```{r Recherche pokémon pouvant battre Lugia, echo = FALSE, message = FALSE}
lugia <- pokemons %>% filter(Name == 'Lugia')
pokemons_nl_sg <- pokemons %>% filter(Legendary == FALSE & Generation == lugia$Generation)
fast_pok <- pokemons_nl_sg %>% filter(Speed >= lugia$Speed)
off_pok <- pokemons_nl_sg %>% filter(Attack >= lugia$Attack)
def_pok <- pokemons_nl_sg %>% filter(Defense >= lugia$Defense)
hp_pok <- pokemons_nl_sg %>% filter(HP >= lugia$HP)
sp_off_pok <- pokemons_nl_sg %>% filter(`Sp. Atk` >= lugia$`Sp. Atk`)
sp_def_pok <- pokemons_nl_sg %>% filter(`Sp. Def` >= lugia$`Sp. Def`)

#Source used to intersect dataframes
#https://dplyr.tidyverse.org/reference/setops.html

#We know that Lugia is of type flying and psychic so we search for type that are strong against that.
pokemon_ws <- read_csv("data/pokemon_ws.csv")
effective_type <- pokemon_ws[pokemon_ws %>% select(lugia$`Type 1`) == 2 | pokemon_ws %>% select(lugia$`Type 2`) == 2,]$Attacking

#Now that we have the type effective against Lugia, we can retrieve the pokemons that have those types.
#We know by looking into the data that Lugia has high scores in special defense, defense and speed. With those caracteristics, it is more unlikely to find pokemons that will surpass Lugia, which is why we will intersect the related dataframes at the end.
effective_pokemons <- pokemons %>% 
  filter(`Type 1` %in% effective_type | `Type 2` %in% effective_type) %>% #We get the pokemons with at least one effective type
  intersect(pokemons_nl_sg) %>% #We keep only the non legendary ones
  intersect(off_pok) %>% #We keep only those who outbest lugia in attack
  intersect(sp_off_pok) %>% #Same here with special attack
  intersect(fast_pok) #Same here with speed

best_pokemon <- effective_pokemons %>% 
  filter(Attack == max(effective_pokemons$Attack)) #We keep only the one with the best attack score.
```

Voici un pokémon qui pourrait battre Lugia:

>
> __Nom__: `r best_pokemon$Name`
>
> __Type 1__: `r best_pokemon$'Type 1'`
>
> __Type 2__: `r ifelse(!is.na(best_pokemon %>% select("Type 2")), best_pokemon %>% select("Type 2"), "None")`
>
> __Points de vie__: `r best_pokemon$HP`
>
> __Attaque__: `r best_pokemon$Attack`
>
> __Defense__: `r best_pokemon$Defense`
>
> __Attaque spécial__: `r best_pokemon$'Sp. Atk'`
>
> __Défense spécial__: `r best_pokemon$'Sp. Def'`
>
> __Vitesse__: `r best_pokemon$Speed`